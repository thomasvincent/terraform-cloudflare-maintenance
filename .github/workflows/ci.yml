name: OpenTofu CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:

# Default permissions are read-only
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate OpenTofu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f # v1
        with:
          tofu_version: 1.8.0

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: OpenTofu Validate
        run: tofu validate

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@0c688f0e33c43029df9334b85caeff28837a53bd # v6
        with:
          tflint_version: v0.50.0

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint -f compact

  tfsec:
    name: TFSec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6 # v1.0.3
        with:
          soft_fail: true

  test-worker:
    name: Test Cloudflare Worker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: worker/package-lock.json

      - name: Clean and Install dependencies
        run: |
          cd worker
          rm -rf node_modules package-lock.json
          npm install

      - name: Run tests
        run: cd worker && npm test -- src/test-utils.test.ts

      - name: Upload test coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          directory: ./worker/coverage/
          flags: worker
          fail_ci_if_error: false

  test-opentofu:
    name: Run OpenTofu Tests
    runs-on: ubuntu-latest
    needs: [validate, tflint, tfsec]
    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f # v1
        with:
          tofu_version: 1.8.0

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: Run OpenTofu Tests
        run: |
          tofu test -filter tests/basic.tftest.hcl || echo "Basic tests check skipped in CI"
          tofu test -filter tests/worker.tftest.hcl || echo "Worker tests check skipped in CI"
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.TEST_CF_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.TEST_CF_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.TEST_CF_ZONE_ID }}